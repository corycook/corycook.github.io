<!DOCTYPE html>
<html>

<head>
  <title>Pulse</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Kumar+One');
    body, html {
      margin: 0;
      padding: 0;
    }
    form {
      display: none;
      width: 800px;
      margin: auto;
    }
    canvas {
      display: block;
      margin: auto;
    }
    #click {
      font-family: 'Kumar One', sans-serif;
      color: white;
      font-size: 100px;
      position: absolute;
      top: 50%;
      margin-top: -50px;
      margin-left: -200px;
      left: 50%;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <form>
    <label>amplitude <input id="A" type="number" step="1" value="30" /></label>
    <label>lambda <input id="lambda" type="number" step="0.1" value="0.8" /></label>
  </form>
  <canvas id="canvas"></canvas>
  <div id="click">TOUCH</div>

  <script>

    function getValue(id) {
      return parseFloat(document.getElementById(id).value);
    }

    var _in = {
      get A() {
        return getValue("A");
      },
      get lambda() {
        return getValue("lambda");
      }
    };

    var squares = [];
    var HSIZE = 30;
    var VSIZE = 30;
    var HEIGHT = window.innerHeight;
    var WIDTH = window.innerWidth;
    var hcount = Math.ceil(HEIGHT / HSIZE);
    var vcount = Math.ceil(WIDTH / VSIZE);

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var fillRule = true;
    var strokeRule = true;
    var mouseX = 0;
    var mouseY = 0;

    function size(width, height) {
      canvas.width = width;
      canvas.height = height;
    }

    function fill(color) {
      ctx.fillStyle = _color(color);
    }

    function noStroke() {
      strokeRule = false;
    }

    function _color(color) {
      if (typeof color === "number") {
        return "rgb(" + color + ", " + color + ", " + color + ")";
      }
      return color;
    }

    function color(r, g, b, a) {
      if (typeof a === "undefined") {
        a = 1;
      }
      return "rgba(" + r + ", " + g + ", " + b + ", " + a + ")";
    }

    function rect(x, y, w, h) {
      ctx.beginPath();
      ctx.rect(x, y, w, h)
      if (fillRule) {
        ctx.fill();
      }
      if (strokeRule) {
        ctx.stroke();
      }
      ctx.closePath();
    }

    function background(color) {
      ctx.beginPath();
      var c = ctx.fillStyle;
      fill(color);
      ctx.clearRect(0, 0, WIDTH, HEIGHT);
      rect(0, 0, WIDTH, HEIGHT);
      fill(c);
      ctx.closePath();
    }

    var _BEGIN = Date.now();
    function millis() {
      return Date.now() - _BEGIN;
    }

    function PVector(x, y) {
      this.x = x;
      this.y = y;
    }
    PVector.prototype = Object.create({
      normalize: function () {
        var length = this.length;
        this.x = this.x / length;
        this.y = this.y / length;
        return this;
      },
      mult: function (scalar) {
        this.x = this.x * scalar;
        this.y = this.y * scalar;
        return this;
      },
      add: function (vec) {
        this.x = this.x + vec.x;
        this.y = this.y + vec.y;
        return this;
      },
      sub: function (x, y) {
        this.x = this.x - x;
        this.y = this.y - y;
        return this;
      },
      get length() {
        return Math.sqrt(this.x * this.x + this.y * this.y);
      }
    });

    function Pulse(x, y, dx, dy) {
      this.LENGTH = 1000;
      this.x = x;
      this.y = y;
      this.dx = dx;
      this.dy = dy;
      this.dist = this.vector.length;
      this.created = millis() + 2 * this.dist;
    }
    Pulse.prototype = Object.create({
      get effect() {
        var result = this.vector;
        result.normalize();
        result.mult(millis() > this.created ? this.amplitude : 0);
        return result;
      },
      get expired() {
        return (millis() - this.created) > this.LENGTH && Math.abs(this.amplitude) < 0.0001;
      },
      get vector() {
        return new PVector(this.dx, this.dy).sub(this.x, this.y);
      },
      get amplitude() {
        var time = (millis() - this.created) / this.LENGTH;
        return -1 * _in.A * Math.exp(-1 * _in.lambda * time) * Math.sin(3 * Math.PI * time);
      }
    });

    function Square(x, y, w) {
      this.left = x;
      this.top = y;
      this.width = w;
      this.vPulses = [];
    }
    Square.prototype = Object.create({
      pulse: function (x, y) {
        this.vPulses.push(new Pulse(this.left, this.top, x, y));
      },
      render: function () {
        var pulse = new PVector(0, 0);
        var vPulses = this.vPulses;
        for (var i = vPulses.length - 1; i >= 0; i--) {
          var p = vPulses[i];
          if (p.expired) {
            vPulses.splice(i, 1);
            continue;
          }
          pulse.add(p.effect);
        }
        rect(this.left + pulse.x, this.top + pulse.y, this.width, this.width);
      }
    })

    function setup() {
      size(WIDTH, HEIGHT);
      noStroke();
      fill(color(150, 150, 200));
      for (var h = 0; h < hcount; h++)
        for (var v = 0; v < vcount; v++)
          squares.push(new Square(v * VSIZE, h * HSIZE, HSIZE));
    }

    function draw() {
      background(255);
      for (var i = 0; i < squares.length; i++)
        squares[i].render();
    }

    function mouseClicked() {
      for (var i = 0; i < squares.length; i++)
        squares[i].pulse(mouseX, mouseY);
    }

    function frame() {
      draw();
      requestAnimationFrame(frame);
    }

    canvas.addEventListener("mousemove", function (e) {
      mouseX = e.offsetX;
      mouseY = e.offsetY;
    });
    if (mouseClicked) {
      canvas.addEventListener("mouseup", mouseClicked);
      canvas.addEventListener("touchstart", function (e) {
        var touch = e.touches.item(0);
        mouseX = touch.clientX;
        mouseY = touch.clientY;
        mouseClicked();
        e.preventDefault();
      });
      canvas.addEventListener("touchend", call("preventDefault"));
    }
    canvas.addEventListener("touchmove", call("preventDefault"));

    function call(fn) {
      return function(o) {
        o[fn].call(o);
      }
    }

    setup();
    requestAnimationFrame(frame);

    window.addEventListener('resize', function () {
      squares = [];
      WIDTH = window.innerWidth;
      HEIGHT = window.innerHeight;
      hcount = Math.ceil(HEIGHT / HSIZE);
      vcount = Math.ceil(WIDTH / VSIZE);
      setup();
    });
  </script>
</body>

</html>